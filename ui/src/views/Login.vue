//    Copyright RPSoft 2019,2020. All Rights Reserved.
//    This file is part of RPSoft Tower.
//
//    Tower is free software: you can redistribute it and/or modify
//    it under the terms of the GNU General Public License as published by
//    the Free Software Foundation; either version 3 of the License, or
//    (at your option) any later version.
//
//    Tower is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU General Public License for more details.
//
//    You should have received a copy of the GNU General Public License
//    along with Tower.  If not, see http://www.gnu.org/licenses/gpl-3.0.html.

<template>
  <div
    v-resize="onResize"
    class="d-flex justify-center align-center"
    style="margin-left:-58px !important; height: 100%"
  >
    <div>
      <svg
        :width="svg.width"
        :height="svg.height"
        xmlns="http://www.w3.org/2000/svg"
        class="path"
        stroke="#919191"
        fill-opacity="0"
        stroke-width="1"
        viewBox="0 0 790.45 798.57"
      ><path
        class="cls-1 cls-last"
        d="M894.8,488.92a387.59,387.59,0,0,1-82.67,239.87C676,761.26,569.48,878.17,505.55,878.17c-215,0-389.24-174.27-389.24-389.25S290.58,99.68,505.55,99.68,894.8,274,894.8,488.92Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-2 cls-all"
        d="M302,231.85s29.92-48,162.66-56.63,219.1,17.8,237.69,55.22c-1.18,20.11-1.25,24.61-1.25,24.61l20,22,12.24,482.86L398.88,891.8,375.19,503.61,324.8,449.42,323,408.32l-3-58.24L309.87,292Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M396.45,847.68c-5.55-53-10-106.11-14.16-159.21s-7.75-106.24-11.11-159.38l-.63-10-.31-5-.16-2.49-.07-1.21c0-.25,0-.5-.08-.75a10.92,10.92,0,0,0-2.42-5.5c-.15-.21-.33-.38-.5-.58l-.66-.65-1.8-1.73-3.6-3.46-28.79-27.68-7.2-6.92-1.91-1.85a17.67,17.67,0,0,1-2.5-3.15,18.57,18.57,0,0,1-2.73-7.53l-1.74-20.17-.85-10L315,418l-.1-1.25c0-.15-.05-.56-.07-.89s0-.69,0-1a18.1,18.1,0,0,1,.52-4.08c.08-.33.17-.66.28-1l.21-.67.38-1.19.75-2.34a4,4,0,0,0,.16-.85c0-.15,0-.29,0-.44s0-.18-.07-.71l-.3-2.48-1.17-9.91-9.28-79.34-1.14-9.92-.56-4.93a3.52,3.52,0,0,0-.21-.92,3.38,3.38,0,0,0-.18-.44l-.11-.21-.3-.53-2.5-4.32-.63-1.08c-.22-.38-.37-.61-.74-1.3a17.49,17.49,0,0,1-1.47-3.75,18.08,18.08,0,0,1-.4-2c0-.33-.08-.66-.11-1l0-.86-.12-2.49-.24-5-1.91-39.89v-.08a6.25,6.25,0,0,1,.58-2.93,46.71,46.71,0,0,1,9-12.62,75.22,75.22,0,0,1,11.34-9.33,139.33,139.33,0,0,1,25-13,252.24,252.24,0,0,1,26.1-8.87c8.79-2.5,17.65-4.63,26.55-6.5A479.54,479.54,0,0,1,448,171.77q13.53-1.26,27.11-1.79c4.52-.23,9.05-.26,13.57-.4s9.05-.13,13.57-.06c18.09.13,36.16.95,54.14,2.7,9,.91,18,1.95,26.89,3.25S601.14,178.18,610,180s17.64,4,26.3,6.67q6.48,2,12.86,4.33c4.24,1.59,8.44,3.29,12.56,5.16a120.55,120.55,0,0,1,23.41,13.68,67.78,67.78,0,0,1,10,9.19,47.65,47.65,0,0,1,4.1,5.4,40,40,0,0,1,3.12,6,39.41,39.41,0,0,0-3.44-5.77,50.07,50.07,0,0,0-4.33-5.1A66.05,66.05,0,0,0,684.29,211a124.42,124.42,0,0,0-23.63-12.35c-16.55-6.67-34-10.74-51.58-13.8-8.79-1.51-17.64-2.63-26.53-3.56s-17.8-1.68-26.71-2.27q-26.73-1.69-53.52-1.12c-17.83.35-35.63,1.64-53.3,3.64a470.41,470.41,0,0,0-52.5,9c-17.26,4-34.35,8.94-50.38,15.77a126.43,126.43,0,0,0-22.6,12.09,63.17,63.17,0,0,0-9.35,7.87,34,34,0,0,0-6.5,9.26l.58-3,2.39,39.87.3,5,.15,2.49,0,.39,0,.24a4.1,4.1,0,0,0,.1.48,4.64,4.64,0,0,0,.37.89l1.15,1.92,2.55,4.29.33.56c.17.29.33.59.49.89a17.71,17.71,0,0,1,.81,1.84,17,17,0,0,1,1,3.92l.63,5,1.24,9.91,9.71,79.29,1.2,9.91.3,2.48c0,.3.14,1.12.16,1.78a17.73,17.73,0,0,1,0,2.06,17.92,17.92,0,0,1-.76,4l-.77,2.42-.38,1.19-.16.52-.06.21a3.7,3.7,0,0,0-.11.87v.22l0,.35.11,1.24.22,2.48.87,9.93,1.72,19.62a4.45,4.45,0,0,0,.66,1.77,4,4,0,0,0,.6.76l1.67,1.62L342,459.9l28.73,27.74,3.59,3.47,1.8,1.73,1.11,1.11c.39.43.78.85,1.14,1.3a25,25,0,0,1,5.48,12.56c.08.58.13,1.15.17,1.73l.08,1.29.13,2.5.26,5,.52,10q4.14,79.79,7.25,159.61C394.17,741.13,395.88,794.37,396.45,847.68Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M648.78,387.14c-.47,8.69-1,17.37-1.58,26.05l-.45,6.51-.11,1.62a10.68,10.68,0,0,1-1.78,5.37,11.16,11.16,0,0,1-1.19,1.48l-1.1,1.2-2.21,2.4-4.41,4.8q-17.72,19.14-35.57,38.13l-2.23,2.37L597,478.25c-.29.35-.6.67-.88,1a22.5,22.5,0,0,0-2.89,4.7,22.78,22.78,0,0,0-1.67,5.21,27,27,0,0,0-.42,5.79q0,6.52-.17,13.05c-.06,4.35-.13,8.69-.24,13-.37,17.39-1,34.76-1.77,52.12-1.57,34.73-3.75,69.42-6.74,104.06-1.5,17.32-3.18,34.64-5.14,51.93s-4.15,34.58-7,51.82c-.81-17.45-1-34.87-.95-52.28s.35-34.79.85-52.17c1-34.76,2.83-69.47,5.25-104.15q1.83-26,4.23-52c.38-4.33.82-8.66,1.25-13s.86-8.66,1.33-13l.36-3.42a31.17,31.17,0,0,1,.67-3.72,30.71,30.71,0,0,1,6.93-13.21c.4-.47.86-.92,1.3-1.38l1.18-1.13,2.36-2.26q18.87-18,37.9-35.87l4.77-4.45L640,426.8l1.19-1.11a7.67,7.67,0,0,0,.93-1,7.34,7.34,0,0,0,1.25-2.34,8.45,8.45,0,0,0,.29-1.37l.24-1.61.94-6.45C646.12,404.34,647.4,395.73,648.78,387.14Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M646,362.2l2.18-29.58,2.34-29.56,1.18-14.78,1.25-14.77,2.5-29.54a3.17,3.17,0,0,1,2.77-2.89l.15,0,29.82-3.68a3.72,3.72,0,0,1,3.16,1.14l.12.12,33.1,35.19a4.5,4.5,0,0,1,1.22,2.84v.23q3,54.53,4.84,109.07t2.8,109.12q.93,54.57.8,109.17c-.1,18.2-.21,36.4-.6,54.6l-.24,13.66L733,686.18q-.33,13.65-.93,27.32-1.27-13.62-2.31-27.24l-1-13.62L727.78,659c-1.31-18.16-2.34-36.33-3.36-54.51q-2.94-54.51-4.73-109.07T717,386.32q-.87-54.58-.69-109.18l1.23,3.08-31.84-36.34,3.28,1.26L659,247.57l2.91-2.9-3.85,29.4-1.93,14.7-2,14.69-4,29.38Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-4 cls-last"
        d="M906.76,737c-14.5,1-28.74,1.92-42.78,3.3s-27.86,3.18-41.42,5.57-26.86,5.33-39.87,8.91-25.74,7.79-38.24,12.56-24.75,10.07-36.88,15.92c-6.07,2.91-12.1,5.94-18.14,9l-4.52,2.34L680.4,797c-3,1.56-6,3.21-9,4.84-24.12,13.09-48.44,27.36-74.12,40.78S544.55,868.59,516.08,878a382.33,382.33,0,0,1-176.5,16.41l-10.86-1.64q-5.4-1-10.78-2c-3.58-.65-7.14-1.45-10.7-2.25s-7.1-1.57-10.62-2.51-7-1.79-10.53-2.77-7-2.06-10.44-3.11l-5.18-1.63c-1.72-.57-3.44-1.15-5.15-1.76-3.43-1.21-6.84-2.43-10.23-3.73,3.64-.31,7.25-.53,10.84-.74,1.8-.12,3.6-.19,5.39-.29l5.38-.37,10.69-.62c3.57-.3,7.11-.48,10.65-.72,14.15-1.1,28.16-2.15,42-3.76s27.53-3.43,41-5.71c3.37-.6,6.74-1.23,10.1-1.79l10-2c3.33-.67,6.64-1.44,9.95-2.15s6.58-1.56,9.87-2.32a528.94,528.94,0,0,0,76.36-25c24.79-10.19,49-22.34,73.63-35.17s49.74-26.45,76.43-38.63c6.68-3,13.41-6,20.3-8.78s13.84-5.44,20.86-8a365.31,365.31,0,0,1,43.34-12.39,305.72,305.72,0,0,1,133,0A290.32,290.32,0,0,1,906.76,737Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M622.43,232.55c-12.44-3.52-25.2-5.36-38-6.8s-25.6-2.23-38.44-2.63-25.68-.58-38.51-.32-25.64.81-38.37,1.91-25.63,2.33-38.32,3.86-25.3,3.52-37.75,6.22c-6.22,1.38-12.42,2.84-18.54,4.62s-12.19,3.72-18.17,5.94a240.22,240.22,0,0,0-34.88,16.26,160.34,160.34,0,0,1,33-20.67,187.14,187.14,0,0,1,18.11-7.52c6.16-2.18,12.4-4.19,18.73-5.83a300.47,300.47,0,0,1,38.43-7.39c12.92-1.71,25.84-2.71,38.74-3.64a522.75,522.75,0,0,1,77.86.82c12.92,1.16,25.82,2.63,38.59,5,3.19.58,6.37,1.21,9.55,1.87s6.32,1.46,9.46,2.28A144.74,144.74,0,0,1,622.43,232.55Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M337.25,397.73a103.32,103.32,0,0,1,15.9-7.74c5.47-2.24,11-4.22,16.61-6.14a254.84,254.84,0,0,1,34.34-9.13c2.91-.57,5.83-1.05,8.75-1.55s5.85-.9,8.77-1.29c5.85-.84,11.71-1.49,17.57-2.13,11.72-1.26,23.47-2.17,35.24-2.87s23.54-1.12,35.44-.93c6,.12,11.84.38,17.73.77s11.76.83,17.62,1.36,11.73,1.08,17.57,1.78,11.69,1.41,17.52,2.24a332,332,0,0,1,34.7,6.57c-11.71-1.09-23.39-1.86-35.1-2.42q-8.77-.5-17.55-.84l-17.55-.71c-11.69-.32-23.4-.76-35-.69-5.78.05-11.59.22-17.42.48s-11.66.52-17.49.88-11.66.7-17.49,1.09-11.66.84-17.48,1.3c-11.64.95-23.27,2-34.79,3.48-5.77.7-11.42,1.76-17.16,2.85s-11.41,2.39-17.09,3.75-11.35,2.81-17,4.37c-2.82.77-5.62,1.61-8.41,2.5A82.35,82.35,0,0,0,337.25,397.73Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M363.6,255a258.81,258.81,0,0,1,5.71,28.6q2.13,14.37,3.31,28.81t1.48,28.95a251.9,251.9,0,0,1-.94,29.15,254.31,254.31,0,0,1-5.72-28.6q-2.13-14.37-3.29-28.8t-1.48-29A258.76,258.76,0,0,1,363.6,255Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M467.49,235.38a284.56,284.56,0,0,1,4.12,30.27c.89,10.1,1.44,20.22,1.71,30.34s.25,20.24-.11,30.38a279.69,279.69,0,0,1-2.55,30.45,277.41,277.41,0,0,1-4.13-30.27q-1.33-15.17-1.71-30.34t.13-30.39A282,282,0,0,1,467.49,235.38Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M586.54,241.14A269.68,269.68,0,0,1,588.47,271q.22,14.88-.49,29.7t-2.31,29.61a267,267,0,0,1-4.74,29.5A267.29,267.29,0,0,1,579,330q-.22-14.88.5-29.7t2.32-29.61A274.24,274.24,0,0,1,586.54,241.14Z"
        transform="translate(-116.31 -99.68)"
      /><path
        class="cls-3 cls-all"
        d="M688.54,278.2c3.78,36.84,6.15,73.7,8.09,110.58s3.21,73.77,4.06,110.67,1.21,73.82,1,110.74-.93,73.86-3,110.83c-3.8-36.83-6.17-73.7-8.1-110.57s-3.22-73.77-4.05-110.68-1.19-73.81-1-110.74S686.45,315.17,688.54,278.2Z"
        transform="translate(-116.31 -99.68)"
      /></svg>
    </div>
    <div
      class="d-flex flex-column justify-space-around align-center"
      style="height: 100%; margin-left: 5em"
    >
      <div
        class="text-h1 primary--text font-weight-medium"
        :style="`opacity: ${loginOpacity}`"
      >
        Tower
      </div>
      <v-card
        flat
        tile
        :class="cardClass"
        class="loginFormClass"
        :style="`opacity: ${loginOpacity}; background-color: transparent`"
      >
        <v-card-text>
          <v-form
            ref="form"
            v-model="form.valid"
          >
            <v-text-field
              ref="loginInput"
              v-model="login"
              data-cy="login"
              autocomplete="Tower login username"
              :prepend-inner-icon="icons.mdiAccount"
              :rules="rules.login"
              :disabled="loginInputsDisabled"
              label="User"
              name="login"
              type="text"
              required
              class="test"
              @focus="invalidLogin = false"
              @keyup.enter="submit"
            />
            <v-text-field
              v-model="pass"
              data-cy="password"
              autocomplete="Tower login password"
              :prepend-inner-icon="icons.mdiLock"
              :rules="rules.pass"
              :disabled="loginInputsDisabled"
              label="Password"
              name="password"
              type="password"
              required
              @focus="invalidLogin = false"
              @keyup.enter="submit"
            />
          </v-form>
        </v-card-text>
        <div
          v-show="invalidLogin"
          class="loginError"
          v-text="errorText"
        />
        <v-card-actions>
          <v-spacer />
          <v-btn
            :loading="loading"
            data-cy="loginButton"
            class="mr-5 px-3"
            :disabled="!form.valid"
            :elevation="!form.valid ? 1 : undefined"
            color="primary"
            block
            @click="submit"
          >
            Login
          </v-btn>
        </v-card-actions>
      </v-card>
    </div>
  </div>
</template>

<script>
  import { mdiAccount, mdiLock } from '@mdi/js'

  export default {
    name: 'Login',
    data: () => ({
      icons: {
        mdiAccount,
        mdiLock
      },

      svg: {
        height: '100pt',
        width: '100pt'
      },

      loginOpacity: 0,

      login: '',
      pass: '',
      loginInputsDisabled: false,
      loading: false,

      errorText: null,

      form: {
        valid: false
      },

      rules: {
        login: [v => !!v || 'User is required'],
        pass: [v => !!v || 'Password is required']
      },

      invalidLogin: false
    }),
    computed: {
      cardClass () {
        const styleClass = 'pa-2 elevation-0'

        if (this.invalidLogin) {
          return `${styleClass} shake`
        }

        return styleClass
      }
    },
    mounted () {
      this.onResize()

      this.$anime.timeline({
        targets: '.path path',
        easing: 'easeInOutSine',
        duration: 1000,
        delay: this.$anime.stagger(150, { start: 500 })
      }).add({
        strokeDashoffset: [this.$anime.setDashoffset, 0]
      }).add({
        delay: 0,
        targets: '.path path',
        fillOpacity: 1,
        'stroke-width': 0
      })

      this.$anime({
        targets: this,
        loginOpacity: 1,
        delay: 2000,
        duration: 2000,
        easing: 'linear'
      })

      // setTimeout(() => {
      //   this.loginInputsDisabled = false
      // }, 4000)

      this.$refs.loginInput.focus()
    },
    async beforeCreate () {
      const response = await this.axios.get(
        `${this.$store.state.mainUrl}/configurations/initialized`
      )

      if (response.status === 200) {
        this.$store.state.initialized = response.data
        if (this.$store.state.initialized === false) {
          await this.$router.push('/initialize')
          return
        }
      }

      let token = this.$cookie.get('token', {
        domain: window.location.hostname,
        samesite: 'Lax'
      })
      if (token) {
        token = JSON.parse(token)
        this.$store.commit('setUserData', token)

        const roles = await this.axios.get(
          `${this.$store.state.mainUrl}/members/getUserRoles`
        )

        this.$store.commit('setUserRoles', roles.data)

        if (token.user.newUser) {
          await this.$router.push('/changePassword')
        } else {
          let path = this.getUserStartPath(roles.data)

          if (!path) {
            path = 'noPermissions'
          }

          await this.$router.push(`/${path}`)
        }
      }
    },
    methods: {
      onResize () {
        const tempHeight = window.innerHeight / 2
        this.svg.height = `${tempHeight}pt`
        this.svg.width = `${tempHeight}pt`
      },
      getUserStartPath (roles) {
        let path = null

        if (this.$store.state.user.username === 'admin' || roles.includes('admin')) {
          return 'settings'
        }

        if (
          roles.includes('configuration.view') ||
          this.$store.state.userRoles.includes('admin')
        ) {
          path = 'archive'
          if (
            roles.includes('configuration.modify') ||
            this.$store.state.userRoles.includes('admin')
          ) {
            path = 'configuration'
          }
        }

        if (path === null) {
          for (const perm of roles) {
            if (perm.startsWith('baseConfigurations')) {
              const split = perm.split('.')
              if (split.length === 3) {
                path = `base/${split[1]}`
              }
            }
          }
        }

        return path
      },
      async submit () {
        if (this.$refs.form.validate()) {
          this.loading = true
          this.loginInputsDisabled = true
          this.invalidLogin = false
          let validUser = true
          const user = await this.axios.post(
            `${this.$store.state.mainUrl}/members/login?include=user`,
            {
              username: this.login,
              password: this.pass
            },
            {
              timeout: 10000
            }
          )

          if (user !== undefined) {
            user.data.username = this.login

            this.$store.commit('setUserData', user.data)

            this.$cookie.set('token', JSON.stringify(user.data), {
              expires: `${user.data.ttl}s`,
              domain: window.location.hostname,
              samesite: 'Lax'
            })

            const roles = await this.axios.get(
              `${this.$store.state.mainUrl}/members/getUserRoles`
            )

            this.$store.commit('setUserRoles', roles.data)

            if (user.data.user.newUser) {
              await this.$router.push('/changePassword')
              return
            } else {
              let path = this.getUserStartPath(roles.data)

              if (!path) {
                path = 'noPermissions'
              }

              await this.$router.push(`/${path}`)
              return
            }
          } else {
            validUser = false
          }

          this.loading = false
          this.loginInputsDisabled = false

          if (!validUser) {
            this.invalidLogin = true
            this.errorText = 'Invalid user or password'
          }
        }
      }
    }
  }
</script>

<style lang="scss" scoped>
.makeItEven {
  margin-top: 0 !important;
  margin-bottom: 30px !important;
}

.loginError {
  color: red;
  text-align: center;
  margin-top: -20px;
}

.shake {
  animation: shake 0.4s;
}

@keyframes shake {
  0% {
    transform: translate(1px, -1px) rotate(-1deg);
  }
  20% {
    transform: translate(-1px, 1px) rotate(1deg);
  }
  40% {
    transform: translate(1px, -1px) rotate(-1deg);
  }
  60% {
    transform: translate(-1px, 1px) rotate(1deg);
  }
  80% {
    transform: translate(1px, -1px) rotate(-1deg);
  }
  100% {
    transform: translate(-1px, 1px) rotate(1deg);
  }
}

input {
  border: 3px solid grey;
  border-radius: 3px;
}

input:-webkit-autofill {
  border: 3px solid blue;
}
input:autofill {
  border: 3px solid blue;
}
</style>
