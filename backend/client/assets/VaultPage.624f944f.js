import{Q as O}from"./QCheckbox.c616ffd9.js";import{Q as V}from"./QInput.72a273ff.js";import{Q as M}from"./QSeparator.ac17e27e.js";import{E as R,ae as q,a3 as z,x as w,m as F,d as $,J as k,k as H,aa as y,H as c,a as r,c as L,a7 as T,aF as j,a9 as E,w as K,Q as W,o as p,I as X,a8 as Y}from"./index.d78f815c.js";import{Q as Z}from"./QToggle.d1194c03.js";import{_ as I}from"./towerSelect.9436c179.js";import{_ as ee}from"./savePanel.faa1b35b.js";import{u as oe}from"./use-quasar.6ef15f16.js";import"./use-key-composition.8fe7b499.js";import"./uid.42677368.js";import"./QSelect.77d64708.js";import"./QMenu.c8dbaa4e.js";import"./selection.faaa34c1.js";import"./rtl.b51694b1.js";const te={class:"tw-h-full tw-flex tw-flex-col"},ae={key:0,class:"tw-flex tw-gap-3"},le={class:"tw-flex-grow tw-mr-3"},ne={key:1},se={class:"tw-grid tw-grid-cols-2 tw-gap-3 tw-mt-3"},re={key:0},ue={class:"tw-w-[20rem]"},ie={class:"tw-mt-5 tw-flex tw-flex-col tw-py-3 tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"},de=c("div",{class:"tw-text-xl tw-font-medium tw-mx-3"},"Test connection",-1),ce=c("div",{class:"tw-text-gray-500 tw-mx-3"}," Test provided connection details ",-1),me={class:"tw-mt-3 tw-flex tw-flex-col tw-py-3 tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"},ve=c("div",{class:"tw-text-xl tw-font-medium tw-mx-3"},"Global token",-1),fe=c("div",{class:"tw-text-gray-500 tw-mx-3"}," Turning on this setting will force Tower to connect to Vault using one token for all the connections ",-1),we=c("div",{class:"tw-flex-grow"},null,-1),Ne=R({__name:"VaultPage",setup(pe){const b=oe(),A=q(),C=z(),l=w(null),o=w(null),u=w(null),x=w([]),i=w(null);F(async()=>{await Q()});const _=$({get:()=>{if(!i.value||!o.value)return;const a=o.value.tokens.find(e=>{var t,n;return e.name===((t=i.value)==null?void 0:t.name)&&e.base===((n=u.value)==null?void 0:n.name)});return a?a.token:null},set:a=>{if(!i.value||!o.value||!u.value)return;const e=o.value.tokens.findIndex(t=>{var n,s;return t.name===((n=i.value)==null?void 0:n.name)&&t.base===((s=u.value)==null?void 0:s.name)});e>=0?o.value.tokens[e]={name:i.value.name,token:a,base:u.value.name}:o.value.tokens.push({name:i.value.name,token:a,base:u.value.name})}}),h=$(()=>{var a,e,t,n,s,m,d,v,f,G,S,B;return!o.value||!l.value?!1:((a=o.value)==null?void 0:a.tokens.length)!==((e=l.value)==null?void 0:e.tokens.length)||((t=o.value)==null?void 0:t.enabled)!==((n=l.value)==null?void 0:n.enabled)||((s=o.value)==null?void 0:s.useGlobalToken)!==((m=l.value)==null?void 0:m.useGlobalToken)||((d=o.value)==null?void 0:d.url)!==((v=l.value)==null?void 0:v.url)||((f=l.value)==null?void 0:f.useGlobalToken)&&((G=o.value)==null?void 0:G.globalToken)!==((S=l.value)==null?void 0:S.globalToken)?!0:(B=o.value)==null?void 0:B.tokens.some(N=>{var U;return!((U=l.value)!=null&&U.tokens.some(g=>g.name===N.name&&g.token===N.token&&g.base===g.base))})}),Q=async()=>{var t,n,s,m,d,v,f;const a={where:{system:"Vault"}},e=await k.get(`/connections?filter=${JSON.stringify(a,void 0,"")}`);e.status===200&&(l.value=e.data[0],l.value&&(o.value={url:(t=l.value)==null?void 0:t.url,enabled:(n=l.value)==null?void 0:n.enabled,globalToken:(s=l.value)==null?void 0:s.globalToken,system:(m=l.value)==null?void 0:m.system,tokens:[...(d=l.value)==null?void 0:d.tokens],_id:(v=l.value)==null?void 0:v._id,useGlobalToken:(f=l.value)==null?void 0:f.useGlobalToken}))},J=async()=>{if(x.value=[],i.value=null,!u.value)return;const a={where:{base:u.value.name},order:"name ASC"},e=await k.get(`/configurationModels?filter=${JSON.stringify(a,void 0,"")}`);e.status===200&&(x.value=e.data)},P=async()=>{var a,e,t,n,s,m;if(!!o.value)try{(await k.post("/connections/testConnection?type=Vault",o.value)).status===204&&b.notify({color:"positive",position:"top",textColor:"secondary",message:"Connection established successfully"})}catch(d){const v=(t=(e=(a=d.response)==null?void 0:a.data)==null?void 0:e.error)!=null&&t.message?(m=(s=(n=d.response)==null?void 0:n.data)==null?void 0:s.error)==null?void 0:m.message:d.message;b.notify({color:"negative",position:"top",textColor:"secondary",icon:"sym_o_error",message:v})}},D=async()=>{if(!!o.value){console.log(o.value);try{await k.patch("/connections",o.value),await Q(),b.notify({color:"positive",position:"top",textColor:"secondary",message:"Connection details saved successfully"})}catch{b.notify({color:"negative",position:"top",textColor:"secondary",icon:"sym_o_error",message:"Error saving connection details"})}}};return H(()=>h.value,a=>{a?C.preventNavigation():C.allowNavigation()}),(a,e)=>(p(),y("div",te,[o.value?(p(),y("div",ae,[c("div",le,[r(O,{modelValue:o.value.enabled,"onUpdate:modelValue":e[0]||(e[0]=t=>o.value.enabled=t),label:"Enable Vault connection",class:"tw-mb-2"},null,8,["modelValue"]),r(V,{label:"URL",modelValue:o.value.url,"onUpdate:modelValue":e[1]||(e[1]=t=>o.value.url=t),color:"secondary",disable:!o.value.enabled},null,8,["modelValue","disable"]),o.value.useGlobalToken?(p(),L(V,{key:0,modelValue:o.value.globalToken,"onUpdate:modelValue":e[2]||(e[2]=t=>o.value.globalToken=t),color:"secondary",label:"Global token"},null,8,["modelValue"])):(p(),y("div",ne,[c("div",se,[r(I,{modelValue:u.value,"onUpdate:modelValue":[e[3]||(e[3]=t=>u.value=t),J],options:T(A).getBases,"option-label":"name",label:"Base"},null,8,["modelValue","options"]),r(I,{modelValue:i.value,"onUpdate:modelValue":e[4]||(e[4]=t=>i.value=t),disable:!u.value,options:x.value,"option-label":"name",label:"Model"},null,8,["modelValue","disable","options"])]),i.value?(p(),y("div",re,[r(V,{modelValue:T(_),"onUpdate:modelValue":e[5]||(e[5]=t=>j(_)?_.value=t:null),label:"Token",color:"secondary"},null,8,["modelValue"])])):E("",!0)]))]),c("div",ue,[c("div",ie,[de,ce,r(M,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),r(W,{class:"tw-bg-secondary tw-mx-3 tw-flex-grow",flat:"","text-color":"primary",disable:!o.value.enabled,onClick:P},{default:K(()=>[r(X,{class:"tw-mr-3",color:"primary",name:"sym_o_cable",size:"sm"}),Y(" Test connection ")]),_:1},8,["disable"])]),c("div",me,[ve,fe,r(M,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),r(Z,{modelValue:o.value.useGlobalToken,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.useGlobalToken=t),color:"accent"},null,8,["modelValue"])])])])):E("",!0),we,r(ee,{"save-enabled":T(h),onSaveClicked:D},null,8,["save-enabled"])]))}});export{Ne as default};
