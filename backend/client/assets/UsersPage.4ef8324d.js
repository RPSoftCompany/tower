import{E as fe,a3 as ye,x,m as xe,d as he,J as h,k as ce,aa as c,H as t,a as l,w as u,T as ke,c as C,a7 as k,a9 as v,o,I as p,Q as z,a5 as i,a4 as V,ac as P,aT as ge,aU as be,a8 as y,ad as Ue}from"./index.d78f815c.js";import{Q as L}from"./QSeparator.ac17e27e.js";import{Q as Ae,b as ie}from"./QMenu.c8dbaa4e.js";import{Q as Ce,b as de}from"./QSelect.77d64708.js";import{_ as ue}from"./towerSelect.9436c179.js";import{_ as Pe}from"./savePanel.faa1b35b.js";import{u as Le}from"./use-quasar.6ef15f16.js";import"./selection.faaa34c1.js";import"./use-key-composition.8fe7b499.js";import"./uid.42677368.js";import"./rtl.b51694b1.js";var f=(N=>(N.LOCAL="local",N.LDAP="ldap",N))(f||{});const Ne={class:"tw-flex tw-flex-col tw-h-full"},Te={class:"tw-flex tw-flex-col tw-items-center tw-overflow-auto"},Se={key:0,class:"tw-flex tw-w-full tw-gap-3"},Qe={class:"tw-flex-grow"},ze={class:"tw-mt-5 tw-py-3 tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"},Ve=t("div",{class:"tw-text-xl tw-font-medium tw-mb-3 tw-px-3"}," User details ",-1),Be={class:"tw-flex tw-pl-1"},$e={class:"tw-text-secondary tw-pl-3 tw-self-center tw-text-xl tw-font-extralight"},De={class:"tw-flex tw-flex-col tw-mx-3 tw-mt-1 tw-text-sm"},Ie={key:0},Oe=t("div",{class:"tw-text-gray-500 tw-text-base"},"Status",-1),Ye=t("div",{class:"tw-text-gray-500 tw-text-base tw-mt-2"},"Type",-1),Ee={class:"tw-pl-3"},Re=t("div",{class:"tw-text-gray-500 tw-text-base tw-mt-2"},"DN",-1),Ge={class:"tw-pl-3"},Je={key:0},Fe=t("div",{class:"tw-text-gray-500 tw-text-base tw-mt-2"}," Technical user ",-1),je={key:0,class:"tw-ml-3"},qe={key:1,class:"tw-text-accent"},He={class:"tw-ml-3"},Me={class:"tw-ml-3"},Ke=t("div",{class:"tw-text-gray-500 tw-text-base tw-mt-2"}," Force password reset ",-1),We={key:0,class:"tw-ml-3"},Xe={key:1,class:"tw-text-accent"},Ze={class:"tw-ml-3"},et={class:"tw-ml-3"},tt={key:3},st=t("div",{class:"tw-text-gray-500 tw-text-base tw-mt-2"}," Technical access token ",-1),at={class:"tw-pl-3"},lt={key:0,class:"tw-mt-3 tw-py-3 tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"},ot=t("div",{class:"tw-text-xl tw-font-medium tw-mb-3 tw-px-3"}," User groups ",-1),rt={class:"tw-w-[20rem]"},nt={key:0,class:"tw-mt-5 tw-flex tw-flex-col tw-py-3 tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"},ct=t("div",{class:"tw-text-xl tw-font-medium tw-mx-3"}," Reset password ",-1),it=t("div",{class:"tw-text-gray-500 tw-mx-3"},[y(" User password will be changed to "),t("span",{class:"tw-font-black"},"changeme"),y(" and will be prompted to change it during the next login ")],-1),dt=t("div",{class:"tw-text-xl tw-mx-3 tw-font-medium"},"Block user",-1),ut=t("div",{class:"tw-text-gray-500 tw-mx-3"},"Lock user account",-1),wt={key:2,class:"tw-mt-3 tw-py-3 tw-flex tw-flex-col tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"},vt=t("div",{class:"tw-text-xl tw-mx-3 tw-font-medium"}," Technical user ",-1),mt=t("div",{class:"tw-text-gray-500 tw-mx-3"},[t("div",null," Technical users access token never expire, but they're not able to login to the user interface. "),t("div",null,"Use this feature for your scripts and API execution")],-1),pt={class:"tw-justify-self-end"},Pt=fe({__name:"UsersPage",setup(N){const $=Le(),D=ye(),T=x([]),a=x(null),e=x(null),B=x([]),_=x(!1),g=x(""),S=x("");let b=!1;xe(async()=>{await O()});const I=he(()=>e.value&&a.value?e.value.newUser!==a.value.newUser||e.value.blocked!==a.value.blocked||e.value.technicalUser!==a.value.technicalUser||e.value.groups.length!==a.value.groups.length?!0:e.value.groups.some(s=>{var n;return!((n=a.value)!=null&&n.groups.some(w=>w===s))}):!!(!a.value&&e.value)),O=async()=>{_.value=!0;const s={order:"username ASC"},n=await h.get(`/members?filter=${JSON.stringify(s,void 0,"")}`);n.status===200&&(T.value=[],n.data.forEach(r=>{T.value.push({newUser:r.newUser,groups:r.groups,blocked:r.blocked,technicalUser:r.technicalUser,display:r.type==="ldap"?r.display:r.username,dn:r.dn,type:r.type,username:r.username,_id:r._id,realm:r.realm})}));const w={order:"name ASC"},m=await h.get(`/groups?$filter=${JSON.stringify(w,void 0,"")}`);m.status===200&&(B.value=[],m.data.forEach(r=>{B.value.push(r.name)})),_.value=!1},we=()=>{e.value&&(e.value.technicalUser=!e.value.technicalUser)},ve=()=>{e.value&&(e.value.blocked=!e.value.blocked)},me=()=>{e.value&&(e.value.newUser=!e.value.newUser)},pe=()=>{b=!0,a.value=null,e.value={newUser:!0,password:"changeme",technicalUser:!1,groups:[],blocked:!1,username:g.value,type:f.LOCAL,display:g.value}},_e=async()=>{var n,w;if(!e.value)return;_.value=!0;let s=e.value;s.type==="local"&&(s={type:f.LOCAL,blocked:s.blocked,username:s.username,technicalUser:s.technicalUser,newUser:s.newUser,groups:s.groups}),e.value.newUser&&!((n=a.value)!=null&&n.newUser)&&(s.password="changeme");try{b?await h.post("/members",s):await h.patch(`/members/${e.value._id}`,s),await O();const m=T.value.find(r=>{var U,A;return b?r.username===((U=e.value)==null?void 0:U.username):r._id===((A=a.value)==null?void 0:A._id)});m&&(e.value.technicalUser!==((w=a.value)==null?void 0:w.technicalUser)&&await h.post(`/members/setAsTechnicalUser?isTechUser=${e.value.technicalUser}&userId=${m._id}`),a.value=m)}catch{$.notify({color:"negative",position:"top",textColor:"secondary",icon:"sym_o_error",message:"Error saving user data"}),_.value=!1;return}$.notify({color:"positive",position:"top",textColor:"secondary",message:"User data saved successfully"}),_.value=!1};return ce(()=>a.value,async s=>{if(S.value="",s){if(b=!1,s.technicalUser)try{const n=await h.get(`/members/getTechnicalUserToken?userId=${s._id}`);n.status===200&&(S.value=n.data)}catch{}e.value={username:s.username,technicalUser:s.technicalUser,display:s.display,groups:[...s.groups],dn:s.dn,newUser:s.newUser,type:s.type,realm:s.realm,_id:s._id,blocked:s.blocked}}else b||(e.value=null)}),ce(()=>I.value,s=>{s&&!_.value?D.preventNavigation():D.allowNavigation()}),(s,n)=>(o(),c("div",Ne,[t("div",Te,[l(ue,{modelValue:a.value,"onUpdate:modelValue":n[0]||(n[0]=w=>a.value=w),filter:g.value,"onUpdate:filter":n[1]||(n[1]=w=>g.value=w),loading:_.value,options:T.value,class:"tw-w-[33.3%]",label:"User","option-label":"display"},{before:u(()=>[l(p,{name:"sym_o_person",size:"sm"})]),after:u(()=>[g.value?(o(),C(z,{key:0,flat:"",padding:"sm",onClick:pe},{default:u(()=>[l(p,{name:"sym_o_add"})]),_:1})):v("",!0)]),_:1},8,["modelValue","filter","loading","options"]),l(ke,{"enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut"},{default:u(()=>{var w,m,r,U,A,Y,E,R,G,J,F,j,q,H,M,K,W,X,Z,ee,te,se,ae,le,oe,re;return[e.value?(o(),c("div",Se,[t("div",Qe,[t("div",ze,[Ve,l(L,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),t("div",Be,[l(p,{name:"sym_o_account_circle",class:"filledLight",size:"4rem"}),t("div",$e,i(e.value.display),1)]),t("div",De,[e.value.username!=="admin"?(o(),c("div",Ie,[Oe,!a.value||e.value.blocked===((w=a.value)==null?void 0:w.blocked)?(o(),c("div",{key:0,class:V(["tw-ml-3",{"tw-text-negative":(m=e.value)==null?void 0:m.blocked,"tw-text-positive":!((r=e.value)!=null&&r.blocked)}])},i((U=e.value)!=null&&U.blocked?"Blocked":"Active"),3)):(o(),c(P,{key:1},[t("span",{class:V(["tw-ml-3",{"tw-text-negative":(A=a.value)==null?void 0:A.blocked,"tw-text-positive":!((Y=a.value)!=null&&Y.blocked)}])},i((E=a.value)!=null&&E.blocked?"Blocked":"Active"),3),l(p,{name:"sym_o_arrow_forward",size:"0.875rem",class:"tw-mb-1 tw-ml-3"}),t("span",{class:V(["tw-ml-3",{"tw-text-negative":(R=e.value)==null?void 0:R.blocked,"tw-text-positive":!((G=e.value)!=null&&G.blocked)}])},i((J=e.value)!=null&&J.blocked?"Blocked":"Active"),3)],64))])):v("",!0),t("div",null,[Ye,t("div",Ee,i(e.value.type),1)]),e.value.type===k(f).LDAP?(o(),c(P,{key:1},[Re,t("div",Ge,i(e.value.dn),1)],64)):(o(),c(P,{key:2},[e.value.username!=="admin"?(o(),c("div",Je,[Fe,!a.value||((F=a.value)==null?void 0:F.technicalUser)===e.value.technicalUser?(o(),c("div",je,i((j=e.value)!=null&&j.technicalUser?"Yes":"No"),1)):(o(),c("div",qe,[t("span",He,i((q=a.value)!=null&&q.technicalUser?"Yes":"No"),1),l(p,{name:"sym_o_arrow_forward",size:"0.875rem",class:"tw-pb-1 tw-ml-3"}),t("span",Me,i((H=e.value)!=null&&H.technicalUser?"Yes":"No"),1)]))])):v("",!0),t("div",null,[Ke,!a.value||((M=a.value)==null?void 0:M.newUser)===e.value.newUser?(o(),c("div",We,i((K=e.value)!=null&&K.newUser?"Yes":"No"),1)):(o(),c("div",Xe,[t("span",Ze,i((W=a.value)!=null&&W.newUser?"Yes":"No"),1),l(p,{name:"sym_o_arrow_forward",size:"0.875rem",class:"tw-pb-1 tw-ml-3"}),t("span",et,i((X=e.value)!=null&&X.newUser?"Yes":"No"),1)]))])],64)),S.value?(o(),c("div",tt,[st,t("div",at,i(S.value),1)])):v("",!0)])]),((Z=e.value)==null?void 0:Z.username)!=="admin"?(o(),c("div",lt,[ot,l(L,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),l(ue,{modelValue:e.value.groups,"onUpdate:modelValue":n[2]||(n[2]=d=>e.value.groups=d),options:B.value,class:"tw-w-full tw-my-2 tw-px-3",label:"User groups",multiple:"","use-chips":"","use-input":"",dense:!1},{option:u(d=>[l(Ae,ge(be(d.itemProps)),{default:u(()=>[l(ie,{avatar:""},{default:u(()=>[l(p,{name:d.selected?"sym_o_check_box":"sym_o_check_box_outline_blank",class:"heavy",size:"sm"},null,8,["name"])]),_:2},1024),l(ie,null,{default:u(()=>[l(Ce,null,{default:u(()=>[y(i(d.opt),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),selected:u(()=>{var d;return[(o(!0),c(P,null,Ue((d=e.value)==null?void 0:d.groups,Q=>{var ne;return o(),c(P,{key:Q},[(ne=a.value)!=null&&ne.groups.includes(Q)?(o(),C(de,{key:0,dense:"",color:"dark","text-color":"secondary",class:"tw-px-3 tw-border tw-border-gray-500"},{default:u(()=>[y(i(Q),1)]),_:2},1024)):(o(),C(de,{key:1,dense:"",color:"secondary","text-color":"dark",class:"tw-px-3 tw-border tw-border-gray-500"},{default:u(()=>[y(i(Q),1)]),_:2},1024))],64)}),128))]}),_:1},8,["modelValue","options"])])):v("",!0)]),t("div",rt,[((ee=e.value)==null?void 0:ee.type)!==k(f).LDAP&&a.value?(o(),c("div",nt,[ct,it,l(L,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),l(z,{class:"tw-bg-secondary tw-mx-3 tw-flex-grow",flat:"","text-color":"primary",onClick:me},{default:u(()=>{var d;return[l(p,{class:"tw-mr-3",color:"primary",name:"sym_o_lock_reset",size:"sm"}),y(" "+i((d=e.value)!=null&&d.newUser?"Undo password reset":"Reset user password"),1)]}),_:1})])):v("",!0),((te=e.value)==null?void 0:te.username)!=="admin"?(o(),c("div",{key:1,class:V([{"tw-mt-5":((se=e.value)==null?void 0:se.type)===k(f).LDAP||!a.value,"tw-mt-3":((ae=e.value)==null?void 0:ae.type)!==k(f).LDAP&&a.value},"tw-flex tw-flex-col tw-py-3 tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"])},[dt,ut,l(L,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),((le=e.value)==null?void 0:le.username)!=="admin"?(o(),C(z,{key:0,class:"tw-bg-secondary tw-mx-3 tw-flex-grow",flat:"","text-color":"primary",onClick:ve},{default:u(()=>{var d;return[l(p,{class:"tw-mr-3",color:"primary",name:"sym_o_lock",size:"sm"}),y(" "+i((d=e.value)!=null&&d.blocked?"Unblock user":"Block user"),1)]}),_:1})):v("",!0)],2)):v("",!0),((oe=e.value)==null?void 0:oe.type)!==k(f).LDAP&&((re=e.value)==null?void 0:re.username)!=="admin"?(o(),c("div",wt,[vt,mt,l(L,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),l(z,{class:"tw-bg-secondary tw-mx-3 tw-flex-grow",onClick:we,flat:"","text-color":"primary"},{default:u(()=>{var d;return[l(p,{class:"tw-mr-3",color:"primary",name:"sym_o_api",size:"sm"}),y(" "+i((d=e.value)!=null&&d.technicalUser?"Revoke technical user":"Set as technical user"),1)]}),_:1})])):v("",!0)])])):v("",!0)]}),_:1})]),t("div",pt,[e.value?(o(),C(Pe,{key:0,"save-enabled":k(I),onSaveClicked:_e,loading:_.value},null,8,["save-enabled","loading"])):v("",!0)])]))}});export{Pt as default};
