import{E as T,a3 as z,x as u,m as $,d as J,J as g,k as H,aa as x,a as l,w as n,aL as K,H as d,Q as G,c as A,a7 as M,a9 as O,o as c,aG as R,aH as Q,a4 as B,a8 as b,a5 as f,aI as F,aJ as j,aT as W,aU as X,I as P,ac as U,ad as Y,aK as Z}from"./index.d78f815c.js";import{Q as ee}from"./QCheckbox.c616ffd9.js";import{Q as m}from"./QInput.72a273ff.js";import{Q as ae,b as L}from"./QMenu.c8dbaa4e.js";import{Q as te,b as S}from"./QSelect.77d64708.js";import{Q as le}from"./QSeparator.ac17e27e.js";import{_ as se}from"./towerSelect.9436c179.js";import{_ as ne}from"./savePanel.faa1b35b.js";import{u as oe}from"./use-quasar.6ef15f16.js";import"./use-key-composition.8fe7b499.js";import"./uid.42677368.js";import"./selection.faaa34c1.js";import"./rtl.b51694b1.js";const de={class:"tw-h-full tw-flex tw-flex-col"},ue={class:"tw-flex tw-gap-3"},re={class:"tw-flex-grow tw-mr-3"},ie={class:"tw-grid tw-grid-cols-2 tw-gap-3"},ce={class:"tw-grid tw-grid-cols-2 tw-gap-3"},be={class:"tw-w-[20rem]"},me={class:"tw-mt-5 tw-flex tw-flex-col tw-py-3 tw-self-start tw-rounded tw-border tw-border-dark tw-bg-dark"},ve=d("div",{class:"tw-text-xl tw-font-medium tw-mx-3"},"Test connection",-1),pe=d("div",{class:"tw-text-gray-500 tw-mx-3"}," Test provided connection details ",-1),fe=d("div",{class:"tw-flex-grow"},null,-1),Be=T({__name:"LdapPage",setup(we){const D=oe(),V=z(),a=u({enabled:!1,system:"",bindCredentials:"",bindDN:"",displayAttribute:"",searchBase:"",url:"",usernameAttribute:"",defaultGroups:[],_id:""}),s=u(null),_=u([]),h=u(!1),C=u(""),r=u(!1),w=u(!1),v=u(!1);$(async()=>{await I()});const N=J(()=>!a.value||!s.value?!1:a.value.enabled!==s.value.enabled||a.value.url!==s.value.url||a.value.system!==s.value.system||a.value.bindDN!==s.value.bindDN||a.value.searchBase!==s.value.searchBase||a.value.bindCredentials!==s.value.bindCredentials||a.value.usernameAttribute!==s.value.usernameAttribute||a.value.displayAttribute!==s.value.displayAttribute||a.value.defaultGroups.length!==s.value.defaultGroups.length?!0:a.value.defaultGroups.length===0?!1:!a.value.defaultGroups.some(o=>{var e;return(e=s.value)==null?void 0:e.defaultGroups.some(t=>t===o)})),I=async()=>{const o={where:{system:"LDAP"}};let e=await g.get(`/connections?filter=${JSON.stringify(o,void 0,"")}`);e.status===200&&(s.value={defaultGroups:e.data[0].defaultGroups?[...e.data[0].defaultGroups]:[],displayAttribute:e.data[0].displayAttribute?e.data[0].displayAttribute:null,url:e.data[0].url?e.data[0].url:null,usernameAttribute:e.data[0].usernameAttribute?e.data[0].usernameAttribute:null,bindDN:e.data[0].bindDN?e.data[0].bindDN:null,bindCredentials:e.data[0].bindCredentials?e.data[0].bindCredentials:null,searchBase:e.data[0].searchBase?e.data[0].searchBase:null,enabled:e.data[0].enabled,system:"LDAP",_id:e.data[0]._id?e.data[0]._id:null},a.value={defaultGroups:e.data[0].defaultGroups?[...e.data[0].defaultGroups]:[],displayAttribute:e.data[0].displayAttribute?e.data[0].displayAttribute:null,url:e.data[0].url?e.data[0].url:null,usernameAttribute:e.data[0].usernameAttribute?e.data[0].usernameAttribute:null,bindDN:e.data[0].bindDN?e.data[0].bindDN:null,bindCredentials:e.data[0].bindCredentials?e.data[0].bindCredentials:null,searchBase:e.data[0].searchBase?e.data[0].searchBase:null,enabled:e.data[0].enabled,system:"LDAP",_id:e.data[0]._id?e.data[0]._id:null}),e=await g.get("/groups"),e.status===200&&(_.value=[],e.data.forEach(t=>{_.value.push(t.name)}))},E=async()=>{var o,e,t,i,p,k;w.value=!0;try{(await g.post("/connections/testConnection?type=LDAP",a.value)).status===200&&(C.value="Connection established successfully",r.value=!1)}catch(y){C.value=(t=(e=(o=y.response)==null?void 0:o.data)==null?void 0:e.error)!=null&&t.message?(k=(p=(i=y.response)==null?void 0:i.data)==null?void 0:p.error)==null?void 0:k.message:y.message,r.value=!0}w.value=!1,h.value=!0},q=async()=>{v.value=!0;try{await g.patch("/connections",a.value)}catch{D.notify({color:"negative",position:"top",textColor:"secondary",icon:"sym_o_error",message:"Error saving connection details"}),v.value=!1;return}s.value={defaultGroups:a.value.defaultGroups,displayAttribute:a.value.displayAttribute,url:a.value.url,usernameAttribute:a.value.usernameAttribute,bindDN:a.value.bindDN,bindCredentials:a.value.bindCredentials,searchBase:a.value.searchBase,enabled:a.value.enabled,system:"LDAP",_id:a.value._id},D.notify({color:"positive",position:"top",textColor:"secondary",message:"Connection details saved successfully"}),v.value=!1};return H(()=>N.value,o=>{o&&!v.value?V.preventNavigation():V.allowNavigation()}),(o,e)=>(c(),x("div",de,[l(K,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=t=>h.value=t)},{default:n(()=>[l(R,{style:{width:"30rem"}},{default:n(()=>[l(Q,{class:B(["tw-text-sm tw-font-semibold tw-text-black",{"tw-bg-accent":r.value,"tw-bg-positive":!r.value}])},{default:n(()=>[b(f(r.value?"Connection error":"Connection established successfully"),1)]),_:1},8,["class"]),l(Q,null,{default:n(()=>[b(f(C.value),1)]),_:1}),l(F,{align:"right"},{default:n(()=>[j(l(G,{class:B({"tw-text-accent":r.value,"tw-text-positive":!r.value}),flat:"",label:"OK"},null,8,["class"]),[[Z]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),d("div",ue,[d("div",re,[l(ee,{modelValue:a.value.enabled,"onUpdate:modelValue":e[1]||(e[1]=t=>a.value.enabled=t),label:"Enable LDAP connection",class:"tw-mb-2"},null,8,["modelValue"]),l(m,{disable:!a.value.enabled,modelValue:a.value.url,"onUpdate:modelValue":e[2]||(e[2]=t=>a.value.url=t),label:"URL",hint:"eg. 'ldap://127.0.0.1:389'",color:"secondary","hide-hint":""},null,8,["disable","modelValue"]),l(m,{disable:!a.value.enabled,modelValue:a.value.searchBase,"onUpdate:modelValue":e[3]||(e[3]=t=>a.value.searchBase=t),label:"Base DN",hint:"eq. 'dc=example,dc=org'","hide-hint":"",color:"secondary"},null,8,["disable","modelValue"]),d("div",ie,[l(m,{disable:!a.value.enabled,modelValue:a.value.bindDN,"onUpdate:modelValue":e[4]||(e[4]=t=>a.value.bindDN=t),label:"User DN",hint:"eq. 'cn=admin,dc=example,dc=org'","hide-hint":"",color:"secondary"},null,8,["disable","modelValue"]),l(m,{disable:!a.value.enabled,modelValue:a.value.bindCredentials,"onUpdate:modelValue":e[5]||(e[5]=t=>a.value.bindCredentials=t),type:"password",label:"User DN password",color:"secondary"},null,8,["disable","modelValue"])]),d("div",ce,[l(m,{disable:!a.value.enabled,modelValue:a.value.usernameAttribute,"onUpdate:modelValue":e[6]||(e[6]=t=>a.value.usernameAttribute=t),label:"Username attribute",hint:"eq. 'uid'","hide-hint":"",color:"secondary"},null,8,["disable","modelValue"]),l(m,{disable:!a.value.enabled,modelValue:a.value.displayAttribute,"onUpdate:modelValue":e[7]||(e[7]=t=>a.value.displayAttribute=t),label:"Display attribute",hint:"eq. 'cn'","hide-hint":"",color:"secondary"},null,8,["disable","modelValue"])]),l(se,{disable:!a.value.enabled,modelValue:a.value.defaultGroups,"onUpdate:modelValue":e[8]||(e[8]=t=>a.value.defaultGroups=t),label:"Default LDAP user group",options:_.value,multiple:"","use-chips":""},{option:n(t=>[l(ae,W(X(t.itemProps)),{default:n(()=>[l(L,{avatar:""},{default:n(()=>[l(P,{name:t.selected?"sym_o_check_box":"sym_o_check_box_outline_blank",class:"heavy",size:"sm"},null,8,["name"])]),_:2},1024),l(L,null,{default:n(()=>[l(te,null,{default:n(()=>[b(f(t.opt),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),selected:n(()=>{var t;return[(c(!0),x(U,null,Y((t=a.value)==null?void 0:t.defaultGroups,i=>{var p;return c(),x(U,{key:i},[(p=s.value)!=null&&p.defaultGroups.includes(i)?(c(),A(S,{key:0,dense:"",color:"dark","text-color":"secondary",class:"tw-px-3 tw-border tw-border-gray-500"},{default:n(()=>[b(f(i),1)]),_:2},1024)):(c(),A(S,{key:1,dense:"",color:"secondary","text-color":"dark",class:"tw-px-3 tw-border tw-border-gray-500"},{default:n(()=>[b(f(i),1)]),_:2},1024))],64)}),128))]}),_:1},8,["disable","modelValue","options"])]),d("div",be,[d("div",me,[ve,pe,l(le,{spaced:"",class:"tw-bg-darkPage tw-mx-[-1px]"}),l(G,{class:"tw-bg-secondary tw-mx-3 tw-flex-grow",flat:"","text-color":"primary",onClick:E,loading:w.value,disable:w.value||!a.value.enabled},{default:n(()=>[l(P,{class:"tw-mr-3",color:"primary",name:"sym_o_cable",size:"sm"}),b(" Test connection ")]),_:1},8,["loading","disable"])])])]),fe,d("div",null,[a.value?(c(),A(ne,{key:0,"save-enabled":M(N),loading:v.value,onSaveClicked:q},null,8,["save-enabled","loading"])):O("",!0)])]))}});export{Be as default};
